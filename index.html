<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details 2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #323130;
            padding: 20px;
            padding-top: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 32px;
        }

        /* User Selector */
        .user-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
        }

        .current-user {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .current-user:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .user-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #0078d4;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-dropdown-icon {
            font-size: 12px;
            color: #605e5c;
        }

        .user-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            min-width: 250px;
        }

        .user-dropdown-menu.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f2f1;
            transition: background 0.2s;
        }

        .user-dropdown-item:hover {
            background: #f3f2f1;
        }

        .user-dropdown-item:last-child {
            border-bottom: none;
        }

        .user-dropdown-item.active {
            background: #e6f4ff;
            font-weight: 600;
        }

        /* Auth Modal */
        .auth-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .auth-overlay.show {
            display: flex;
        }

        .auth-modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 450px;
            padding: 32px;
        }

        .auth-modal-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #323130;
        }

        .auth-modal-subtitle {
            font-size: 14px;
            color: #605e5c;
            margin-bottom: 24px;
        }

        .auth-form-group {
            margin-bottom: 20px;
        }

        .auth-form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #323130;
        }

        .auth-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .auth-select:focus {
            outline: none;
            border-color: #0078d4;
        }

        .auth-checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .auth-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .auth-checkbox-label {
            font-size: 14px;
            color: #323130;
            cursor: pointer;
        }

        .auth-submit-btn {
            width: 100%;
            padding: 12px 24px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .auth-submit-btn:hover {
            background: #106ebe;
        }

        .auth-submit-btn:disabled {
            background: #c8c6c4;
            cursor: not-allowed;
        }

        /* Header */
        .page-header {
            border-bottom: 2px solid #0078d4;
            padding-bottom: 16px;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #0078d4;
        }

        .header-badges {
            display: flex;
            gap: 8px;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.streaming {
            background: #8764b8;
            color: white;
        }

        .badge.billing {
            background: #00b7c3;
            color: white;
        }

        .badge.budget {
            background: #107c10;
            color: white;
        }

        /* Info Grid */
        .info-section {
            margin-bottom: 32px;
            padding: 24px;
            background: #fafafa;
            border-radius: 8px;
            border-left: 4px solid #0078d4;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .info-item {
            padding: 0;
            background: transparent;
            border-radius: 0;
            border-left: none;
        }

        .info-label {
            font-size: 12px;
            color: #605e5c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .info-value {
            font-size: 15px;
            color: #323130;
            font-weight: 500;
        }

        /* Overall Status - Text Only */
        .overall-status {
            font-size: 16px;
            font-weight: 700;
        }

        .overall-status.confirmed {
            color: #107c10;
        }

        .overall-status.awaiting {
            color: #f7630c;
        }

        /* Section Title */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #0078d4;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #0078d4;
            border-radius: 2px;
        }

        .team-role {
            font-size: 12px;
            color: #605e5c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .team-name {
            font-size: 15px;
            font-weight: 500;
            color: #323130;
        }

        /* Comments Section */
        .comment-box {
            padding: 16px;
            background: #fff4ce;
            border-radius: 4px;
            border-left: 4px solid #f7630c;
            margin-bottom: 0;
        }

        .comment-label {
            font-size: 12px;
            color: #605e5c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .comment-text {
            font-size: 14px;
            color: #323130;
            line-height: 1.5;
        }

        .comment-empty {
            font-style: italic;
            color: #a19f9d;
        }

        /* Collapsible Extended Details */
        .collapsible-section {
            margin-bottom: 32px;
            padding: 24px;
            background: #fafafa;
            border-radius: 8px;
            border-left: 4px solid #0078d4;
        }

        .collapsible-header {
            padding: 0;
            background: transparent;
            border-radius: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
            margin-bottom: 0;
        }

        .collapsible-header:hover {
            opacity: 0.8;
        }

        .collapsible-title {
            font-size: 18px;
            font-weight: 600;
            color: #0078d4;
        }

        .collapsible-icon {
            font-size: 20px;
            color: #605e5c;
            transition: transform 0.3s;
        }

        .collapsible-icon.open {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.open {
            max-height: 500px;
        }

        .collapsible-inner {
            padding: 20px 0 0 0;
            background: transparent;
            border-radius: 0;
        }

        .detail-item {
            padding: 12px 0;
            border-bottom: 1px solid #e1e1e1;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-item-label {
            font-size: 12px;
            color: #605e5c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .detail-item-value {
            font-size: 14px;
            color: #323130;
            line-height: 1.5;
        }

        /* Status Section */
        .status-section-wrapper {
            margin-bottom: 32px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .status-card {
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
            border: 2px solid #e1e1e1;
        }

        .status-label {
            font-size: 14px;
            color: #605e5c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .status-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .status-confirmed {
            color: #107c10;
        }

        .status-pending {
            color: #f7630c;
        }

        .status-rejected {
            color: #d13438;
        }

        .status-not-uploaded {
            color: #a19f9d;
        }

        .status-meta {
            font-size: 12px;
            color: #797775;
            margin-bottom: 12px;
        }

        .status-comment {
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            color: #323130;
            border: 1px solid #e1e1e1;
        }

        .status-comment.confirmed-bg {
            background: rgba(16, 124, 16, 0.1);
            border-color: rgba(16, 124, 16, 0.3);
        }

        .status-comment.pending-bg {
            background: rgba(247, 99, 12, 0.1);
            border-color: rgba(247, 99, 12, 0.3);
        }

        .status-comment.rejected-bg {
            background: rgba(209, 52, 56, 0.1);
            border-color: rgba(209, 52, 56, 0.3);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 12px 32px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #0078d4;
            color: white;
        }

        .btn-primary:hover {
            background: #106ebe;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background: white;
            color: #0078d4;
            border: 2px solid #0078d4;
        }

        .btn-secondary:hover {
            background: #f3f2f1;
        }

        /* Files Section */
        .files-section {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 2px solid #e1e1e1;
        }

        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e1e1e1;
            margin-bottom: 16px;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #605e5c;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #f3f2f1;
        }

        .tab.active {
            color: #0078d4;
            border-bottom-color: #0078d4;
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #fafafa;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .file-item:hover {
            background: #f3f2f1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 15px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 4px;
        }

        .file-meta {
            font-size: 12px;
            color: #605e5c;
        }

        .download-btn {
            padding: 8px 16px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .download-btn:hover {
            background: #106ebe;
        }

        .not-uploaded {
            text-align: center;
            color: #a19f9d;
            font-size: 14px;
            padding: 32px;
        }

        /* Update Modal */
        .update-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }

        .update-modal-overlay.show {
            display: flex;
        }

        .update-modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            padding: 32px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .update-modal-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #323130;
        }

        .update-form-section {
            margin-bottom: 24px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .update-form-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #323130;
        }

        .update-form-group {
            margin-bottom: 16px;
        }

        .update-form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #323130;
        }

        .update-form-label .required {
            color: #d13438;
        }

        .update-form-select,
        .update-form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 14px;
        }

        .update-form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .update-form-select:focus,
        .update-form-textarea:focus {
            outline: none;
            border-color: #0078d4;
        }

        .update-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .update-modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .update-modal-btn.cancel {
            background: #f3f2f1;
            color: #323130;
        }

        .update-modal-btn.cancel:hover {
            background: #e1e1e1;
        }

        .update-modal-btn.submit {
            background: #0078d4;
            color: white;
        }

        .update-modal-btn.submit:hover {
            background: #106ebe;
        }

        .update-modal-btn.submit:disabled {
            background: #c8c6c4;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- User Authentication Modal -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <h2 class="auth-modal-title">Select Your Account</h2>
            <p class="auth-modal-subtitle">Choose your account to continue</p>
            
            <div class="auth-form-group">
                <label class="auth-form-label" for="userSelect">Your Account</label>
                <select class="auth-select" id="userSelect">
                    <option value="">-- Select Your Account --</option>
                </select>
            </div>

            <div class="auth-checkbox-group">
                <input type="checkbox" id="rememberMe" class="auth-checkbox">
                <label for="rememberMe" class="auth-checkbox-label">Remember me on this device</label>
            </div>

            <button class="auth-submit-btn" id="authSubmit" disabled>Continue</button>
        </div>
    </div>

    <!-- User Selector in Top Right -->
    <div class="user-selector" id="userSelector" style="display: none;">
        <div class="current-user" onclick="toggleUserDropdown()">
            <div class="user-icon" id="userIcon"></div>
            <span class="user-name" id="currentUserName"></span>
            <span class="user-dropdown-icon">▼</span>
        </div>
        <div class="user-dropdown-menu" id="userDropdownMenu"></div>
    </div>

    <!-- Main Content -->
    <div class="container" id="mainContent" style="display: none;">
        <!-- Header -->
        <div class="page-header">
            <h1 class="page-title" id="pageTitle"></h1>
            <div class="header-badges">
                <div class="badge streaming" id="streamingBadge"></div>
                <div class="badge billing" id="billingBadge"></div>
                <div class="badge budget" id="budgetBadge"></div>
            </div>
        </div>

        <!-- First Section: All Basic Info -->
        <div class="info-section">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Advertiser</div>
                    <div class="info-value" id="advertiser"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Agency</div>
                    <div class="info-value" id="agency"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Vendor</div>
                    <div class="info-value" id="vendor"></div>
                </div>
            </div>

            <div style="height: 20px;"></div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Flight Dates</div>
                    <div class="info-value" id="flightDates"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Placement</div>
                    <div class="info-value" id="placement"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Overall Status</div>
                    <div class="overall-status" id="overallStatus"></div>
                </div>
            </div>

            <div style="height: 32px;"></div>

            <!-- Team Members -->
            <div class="info-grid">
                <div class="info-item">
                    <div class="team-role">Account Executive</div>
                    <div class="team-name" id="aeName"></div>
                </div>
                <div class="info-item">
                    <div class="team-role">Campaign Manager</div>
                    <div class="team-name" id="cmName"></div>
                </div>
                <div class="info-item">
                    <div class="team-role">Operations Lead</div>
                    <div class="team-name" id="olName"></div>
                </div>
            </div>

            <div style="height: 32px;"></div>

            <!-- AMP Comment -->
            <div class="comment-box">
                <div class="comment-label">Ampersand Comment</div>
                <div class="comment-text" id="ampComment"></div>
            </div>
        </div>

        <!-- Collapsible Extended Order Details -->
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleExtendedDetails()">
                <span class="collapsible-title">Extended Order Details</span>
                <span class="collapsible-icon" id="extendedIcon">▼</span>
            </div>
            <div class="collapsible-content" id="extendedContent">
                <div class="collapsible-inner">
                    <div class="detail-item">
                        <div class="detail-item-label">Geo Target</div>
                        <div class="detail-item-value" id="geoTarget"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-item-label">Demo Target</div>
                        <div class="detail-item-value" id="demoTarget"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-item-label">List Match</div>
                        <div class="detail-item-value" id="listMatch"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Section -->
        <div class="status-section-wrapper">
            <h2 class="section-title">Detailed Status</h2>
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-label">Order Status</div>
                    <div class="status-value" id="orderStatus"></div>
                    <div class="status-meta" id="orderStatusMeta"></div>
                    <div class="status-comment" id="orderStatusComment"></div>
                </div>
                <div class="status-card">
                    <div class="status-label">Traffic Status</div>
                    <div class="status-value" id="trafficStatus"></div>
                    <div class="status-meta" id="trafficStatusMeta"></div>
                    <div class="status-comment" id="trafficStatusComment"></div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openUpdateForm()">Submit an Update</button>
                <button class="btn btn-secondary" onclick="emailTeam()">Email the Team</button>
            </div>
        </div>

        <!-- Files Section -->
        <div class="files-section">
            <h2 class="section-title">Files</h2>
            <div class="tabs">
                <button class="tab active" data-type="IO" onclick="switchTab('IO')">IO</button>
                <button class="tab" data-type="Traffic" onclick="switchTab('Traffic')">Traffic</button>
                <button class="tab" data-type="Other" onclick="switchTab('Other')">Other</button>
            </div>
            <div class="file-list" id="fileList"></div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div class="update-modal-overlay" id="updateModalOverlay">
        <div class="update-modal">
            <h2 class="update-modal-title">Update Order Status</h2>
            
            <div class="update-form-section">
                <h3>Order Status</h3>
                <div class="update-form-group">
                    <label class="update-form-label">Status</label>
                    <select class="update-form-select" id="updateOrderStatus">
                        <option value="">-- Select Status --</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="update-form-group">
                    <label class="update-form-label" id="orderCommentLabel">
                        Comments <span style="color: #605e5c;">(optional)</span>
                    </label>
                    <textarea class="update-form-textarea" id="updateOrderComments" placeholder="Enter your comments..."></textarea>
                </div>
            </div>

            <div class="update-form-section">
                <h3>Traffic Status</h3>
                <div class="update-form-group">
                    <label class="update-form-label">Status</label>
                    <select class="update-form-select" id="updateTrafficStatus">
                        <option value="">-- Select Status --</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="update-form-group">
                    <label class="update-form-label" id="trafficCommentLabel">
                        Comments <span style="color: #605e5c;">(optional)</span>
                    </label>
                    <textarea class="update-form-textarea" id="updateTrafficComments" placeholder="Enter your comments..."></textarea>
                </div>
            </div>

            <div class="update-modal-actions">
                <button class="update-modal-btn cancel" onclick="closeUpdateForm()">Cancel</button>
                <button class="update-modal-btn submit" id="submitUpdateBtn" onclick="submitUpdate()">Submit Update</button>
            </div>
        </div>
    </div>

    <script>
// ===============================
// User data
// ===============================
const usersData = [
  { name: "Matt Day", email: "matt@ribeye.media", initials: "MD" },
  { name: "Kostia Rymar (Guest)", email: "rymarkostia@gmail.com", initials: "KR" },
  { name: "Salsa Chebli", email: "salsabil.c@gmail.com", initials: "SC" },
  { name: "Natasha Levinsohn", email: "Natasha.Levinsohn@ampersand.tv", initials: "NL" },
  { name: "Maura Riley", email: "Maura.Riley@ampersand.tv", initials: "MR" }
];

let orderData = null;
let filesData = null;
let currentTab = 'IO';
let currentUser = null;
let orderId = null;

const API_BASE_URL = 'https://default4657d5eea660475fbb1099b5df3efd.46.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/c64389bbba15477eb0b909200beb65b1/triggers/manual/paths/invoke';

// ===============================
// Helpers (DOM guards & assertions)
// ===============================
function reqEl(id) {
  const el = document.getElementById(id);
  if (!el) {
    console.error(`[UI] Missing required element #${id}. Was the view inserted/visible?`);
    throw new Error(`Missing element #${id}`);
  }
  return el;
}

function assertRequiredIds(ids) {
  const missing = ids.filter(id => !document.getElementById(id));
  if (missing.length) {
    console.error('Missing required DOM ids:', missing);
    throw new Error('Missing required DOM ids: ' + missing.join(', '));
  }
}

// ===============================
// API fetch + response normalization
// ===============================
async function fetchOrderData(id) {
  try {
    const url =
      API_BASE_URL +
      '?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=OymdpruJbg2QyqJstyrh8qKTXDltEiQax89t2odSIvc&id=' +
      encodeURIComponent(id);

    console.log('Fetching from:', url);

    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });

    console.log('Response status:', response.status);

    if (!response.ok) {
      console.error('Response not OK:', response.status, response.statusText);
      showErrorModal();
      return false;
    }

    const data = await response.json();
    console.log('Response data:', data);

    if (!data.order || !data.files) {
      console.error('Invalid response structure:', data);
      showErrorModal();
      return false;
    }

    // Normalize once here to the shape the page expects
    orderData = normalizeOrder(data.order);
    filesData = data.files;
    return true;

  } catch (error) {
    console.error('Error fetching order data:', error);
    showErrorModal();
    return false;
  }
}

/**
 * Normalize raw Power Automate/SharePoint payload to the shape this page expects.
 * - Handles FlightStar -> FlightStart
 * - Maps CM -> CampaignManager, Vendor -> MVPDContacts.Value
 * - Accepts choice fields as string or object with .Value
 * - Fixes inverted date range (optional swap if end < start)
 */
function normalizeOrder(raw) {
  const order = { ...raw };

  // ---- Field name alignment ----
  // Title/Advertiser
  if (!order.Title && order.Advertiser) order.Title = order.Advertiser;

  // Campaign Manager (CM alias)
  if (!order.CampaignManager && order.CM) order.CampaignManager = order.CM;

  // Vendor (this view reads MVPDContacts.Value)
  if (!order.MVPDContacts && order.Vendor) {
    order.MVPDContacts = { Value: order.Vendor };
  }

  // Flight dates
  if (!order.FlightStart && order.FlightStar) order.FlightStart = order.FlightStar;

  if (order.FlightStart && order.FlightEnd) {
    const s = new Date(order.FlightStart), e = new Date(order.FlightEnd);
    if (e < s) {
      // Some feeds return the range reversed—swap to prevent confusing UI.
      const tmp = order.FlightEnd;
      order.FlightEnd = order.FlightStart;
      order.FlightStart = tmp;
    }
  }

  // ---- Choice fields: tolerate string OR object ----
  const ensureChoice = (v) => (v && typeof v === 'object' && 'Value' in v) ? v : (v ? { Value: v } : v);

  if (order.StreamingvsAddressable) order.StreamingvsAddressable = ensureChoice(order.StreamingvsAddressable);
  if (order.Billingparty)          order.Billingparty          = ensureChoice(order.Billingparty);
  if (order.Status)                order.Status                = ensureChoice(order.Status);
  if (order.TrafficStatus)         order.TrafficStatus         = ensureChoice(order.TrafficStatus);

  // Handle double-encoded "Order Type" if needed later
  if (order["Order Type"] && typeof order["Order Type"] === 'string' && order["Order Type"].trim().startsWith('{')) {
    try {
      const parsed = JSON.parse(order["Order Type"]);
      if (parsed?.Value) order["Order Type"] = parsed;
    } catch {}
  }

  return order;
}

// ===============================
// Error modal
// ===============================
function showErrorModal() {
  const errorHtml =
    '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99999; display: flex; align-items: center; justify-content: center;">' +
      '<div style="background: white; padding: 40px; border-radius: 8px; max-width: 500px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">' +
        '<div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>' +
        '<h2 style="color: #d13438; margin-bottom: 16px; font-size: 24px;">Unable to Load Order</h2>' +
        '<p style="color: #605e5c; margin-bottom: 24px; font-size: 16px; line-height: 1.5;">We couldn\'t retrieve the order information. This could be due to an invalid order ID or a connection issue.</p>' +
        '<p style="color: #323130; font-weight: 600; margin-bottom: 24px; font-size: 14px;">Please reach out to the team via email for assistance.</p>' +
        '<a href="mailto:support@ampersand.tv?subject=Order Access Issue&body=I am unable to access order details. Please assist." style="display: inline-block; padding: 12px 32px; background: #0078d4; color: white; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 16px;">Email Support Team</a>' +
      '</div>' +
    '</div>';

  document.body.insertAdjacentHTML('beforeend', errorHtml);
}

// ===============================
// URL ID extraction + debug
// ===============================
function extractOrderIdFromPath() {
  const urlParams = new URLSearchParams(window.location.search);
  const queryId = urlParams.get('id');
  if (queryId) return queryId;

  const path = window.location.pathname;
  const cleanPath = path.replace('/ampdigital/', '').replace('/ampdigital', '').replace('.html', '');
  const parts = cleanPath.split('/').filter(p => p && p.trim() !== '');
  for (let i = parts.length - 1; i >= 0; i--) {
    const part = parts[i];
    if (!isNaN(part) && part !== '') return part;
  }
  return null;
}

function showDebugBox() {
  const debugBox = document.getElementById('debugBox');
  const debugContent = document.getElementById('debugContent');
  const fullUrl = window.location.href;
  const path = window.location.pathname;
  const search = window.location.search;
  const extractedId = extractOrderIdFromPath();

  debugContent.innerHTML =
    '<div><strong>Full URL:</strong> ' + fullUrl + '</div>' +
    '<div><strong>Path:</strong> ' + path + '</div>' +
    '<div><strong>Query:</strong> ' + (search || 'none') + '</div>' +
    '<div><strong>Extracted ID:</strong> ' + (extractedId || 'not found') + '</div>' +
    '<div><strong>User:</strong> ' + (currentUser ? currentUser.email : 'not logged in') + '</div>';

  debugBox.style.display = 'block';
  setTimeout(function() { debugBox.style.display = 'none'; }, 10000);
}
function closeDebugBox() {
  document.getElementById('debugBox').style.display = 'none';
}

// ===============================
// Auth & user selection
// ===============================
function checkAuthentication() {
  orderId = extractOrderIdFromPath();

  if (orderId) {
    showDebugBox();
  } else {
    showErrorModal();
    return;
  }

  const savedUser = localStorage.getItem('selectedUser');
  if (savedUser) {
    try {
      currentUser = JSON.parse(savedUser);
      showMainContent();
    } catch (e) {
      showAuthModal();
    }
  } else {
    showAuthModal();
  }
}

function showAuthModal() {
  const authOverlay = document.getElementById('authOverlay');
  const userSelect = document.getElementById('userSelect');

  usersData.forEach(function(user) {
    const option = document.createElement('option');
    option.value = JSON.stringify(user);
    option.textContent = user.name + ' (' + user.email + ')';
    userSelect.appendChild(option);
  });

  authOverlay.classList.add('show');
}

document.getElementById('userSelect').addEventListener('change', function() {
  const submitBtn = document.getElementById('authSubmit');
  submitBtn.disabled = !this.value;
});

document.getElementById('authSubmit').addEventListener('click', function() {
  const userSelect = document.getElementById('userSelect');
  const rememberMe = document.getElementById('rememberMe').checked;

  if (userSelect.value) {
    currentUser = JSON.parse(userSelect.value);
    if (rememberMe) {
      localStorage.setItem('selectedUser', JSON.stringify(currentUser));
    }
    document.getElementById('authOverlay').classList.remove('show');
    showMainContent();
  }
});

// ===============================
// Main content flow
// ===============================
async function showMainContent() {
  document.getElementById('userIcon').textContent = currentUser.initials;
  document.getElementById('currentUserName').textContent = currentUser.name;
  document.getElementById('userSelector').style.display = 'block';

  populateUserDropdown();

  const mainContent = document.getElementById('mainContent');
  mainContent.style.display = 'block';
  mainContent.innerHTML =
    '<div style="text-align: center; padding: 100px 20px;">' +
      '<div style="font-size: 48px; margin-bottom: 20px;">⏳</div>' +
      '<div style="font-size: 20px; color: #605e5c;">Loading order details...</div>' +
    '</div>';

  const success = await fetchOrderData(orderId);
  console.log('fetchOrderData success?', success);

  if (success) {
    // Clone and insert template BEFORE populating
    const template = document.getElementById('mainContentTemplate');
    mainContent.innerHTML = template.innerHTML;
    initializePage();
  }
}

function populateUserDropdown() {
  const dropdownMenu = document.getElementById('userDropdownMenu');
  dropdownMenu.innerHTML = '';

  usersData.forEach(function(user) {
    const item = document.createElement('div');
    item.className = 'user-dropdown-item';
    if (user.email === currentUser.email) item.classList.add('active');

    item.innerHTML =
      '<div style="font-weight: 600;">' + user.name + '</div>' +
      '<div style="font-size: 12px; color: #605e5c;">' + user.email + '</div>';

    item.onclick = function() { switchUser(user); };
    dropdownMenu.appendChild(item);
  });
}

function toggleUserDropdown() {
  const dropdown = document.getElementById('userDropdownMenu');
  dropdown.classList.toggle('show');
}

document.addEventListener('click', function(event) {
  const userSelector = document.getElementById('userSelector');
  const dropdown = document.getElementById('userDropdownMenu');
  if (!userSelector.contains(event.target)) {
    dropdown.classList.remove('show');
  }
});

function switchUser(user) {
  currentUser = user;
  localStorage.setItem('selectedUser', JSON.stringify(currentUser));
  document.getElementById('userIcon').textContent = user.initials;
  document.getElementById('currentUserName').textContent = user.name;
  populateUserDropdown();
  document.getElementById('userDropdownMenu').classList.remove('show');
  console.log('User switched to:', user.email);
  logDownloadActivity('User switched', user.email);
}

// ===============================
// Initialize + populate
// ===============================
function initializePage() {
  // Make sure all IDs the script will touch actually exist in the template
  assertRequiredIds([
    'streamingBadge','billingBadge','opid','advertiser','agency','vendor',
    'flightDates','ae','cm','ampComment','orderStatus','orderStatusTime',
    'trafficStatus','trafficStatusTime','fileList'
  ]);
  populateOrderDetails();
  renderFiles();
}

function populateOrderDetails() {
  reqEl('streamingBadge').textContent =
    orderData.StreamingvsAddressable?.Value ?? orderData.StreamingvsAddressable ?? 'N/A';
  reqEl('billingBadge').textContent =
    orderData.Billingparty?.Value ?? orderData.Billingparty ?? 'N/A';

  reqEl('opid').textContent = orderData.OPID || 'N/A';
  reqEl('advertiser').textContent = orderData.Title || 'N/A';
  reqEl('agency').textContent = orderData.Agency || 'N/A';
  reqEl('vendor').textContent =
    orderData.MVPDContacts?.Value ?? orderData.Vendor ?? 'N/A';

  const flightStart = formatDate(orderData.FlightStart);
  const flightEnd = formatDate(orderData.FlightEnd);
  reqEl('flightDates').textContent = flightStart + ' - ' + flightEnd;

  reqEl('ae').textContent =
    orderData.AE?.DisplayName ?? orderData.AE?.Title ?? 'N/A';
  reqEl('cm').textContent =
    orderData.CampaignManager?.DisplayName ?? orderData.CM?.DisplayName ?? 'N/A';

  const ampCommentEl = reqEl('ampComment');
  if (orderData.AMPComment) {
    ampCommentEl.textContent = orderData.AMPComment;
  } else {
    ampCommentEl.innerHTML = '<span class="comment-empty">No comment</span>';
  }

  const orderStatus = orderData.Status?.Value ?? orderData.Status ?? 'Unknown';
  const orderStatusEl = reqEl('orderStatus');
  orderStatusEl.textContent = orderStatus;
  orderStatusEl.className = 'status-value ' + getStatusClass(orderStatus);

  const orderStatusTime = reqEl('orderStatusTime');
  if (orderData.Statuschange) {
    let timeText = formatDateTime(orderData.Statuschange);
    if (orderData.StatusUpdatedby) {
      timeText += ' by ' + orderData.StatusUpdatedby;
    }
    orderStatusTime.textContent = timeText;
  } else {
    orderStatusTime.textContent = 'Never updated';
  }

  const trafficStatus = orderData.TrafficStatus?.Value ?? orderData.TrafficStatus ?? 'Unknown';
  const trafficStatusEl = reqEl('trafficStatus');
  trafficStatusEl.textContent = trafficStatus;
  trafficStatusEl.className = 'status-value ' + getStatusClass(trafficStatus);

  const trafficStatusTime = reqEl('trafficStatusTime');
  if (orderData.TrafficStatusChange) {
    let timeText = formatDateTime(orderData.TrafficStatusChange);
    if (orderData.TrafficStatusUpdatedby) {
      timeText += ' by ' + orderData.TrafficStatusUpdatedby;
    }
    trafficStatusTime.textContent = timeText;
  } else {
    trafficStatusTime.textContent = 'Never updated';
  }
}

// ===============================
// Utilities (formatting & status)
// ===============================
function getStatusClass(status) {
  if (status === 'Confirmed') return 'status-confirmed';
  if (status === 'Pending')   return 'status-pending';
  if (status === 'Rejected')  return 'status-rejected';
  return '';
}
function formatDate(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
}
function formatDateTime(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return (
    date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }) +
    ' ' +
    date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
  );
}
function formatFileDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' });
}

// ===============================
// Tabs + Files rendering
// ===============================
function switchTab(tabName) {
  currentTab = tabName;
  document.querySelectorAll('.tab').forEach(function(tab) { tab.classList.remove('active'); });
  const btn = document.querySelector('[data-type="' + tabName + '"]');
  if (btn) btn.classList.add('active');
  renderFiles();
}

function renderFiles() {
  const fileList = reqEl('fileList');

  const filteredFiles = (filesData || []).filter(function(file) {
    return file.file_type && (file.file_type.Value === currentTab || file.file_type === currentTab);
  });

  if (filteredFiles.length === 0) {
    fileList.innerHTML = '<div class="not-uploaded">No files available for this category</div>';
    return;
  }

  fileList.innerHTML = filteredFiles.map(function(file) {
    const fileName = file['{Name}'] || file.Name || 'Unnamed File';
    const fileType = file.file_type ? (file.file_type.Value || file.file_type) : 'Unknown';
    const fileDate = formatFileDate(file.Created);

    // Try both {FullPath} and FullPath
    const rawFullPath = file['{FullPath}'] || file.FullPath || '';
    let sourceUrl = rawFullPath;

    // If it's relative, prepend the site path
    if (sourceUrl && !sourceUrl.startsWith('/sites/PoliticalStreaming/')) {
      sourceUrl = '/sites/PoliticalStreaming/' + sourceUrl;
    }

    const downloadUrl = sourceUrl
      ? 'https://datadriventv.sharepoint.com/sites/PoliticalStreaming/_layouts/15/download.aspx?SourceUrl=' +
        encodeURIComponent(sourceUrl)
      : '#';

    // Escape single quotes for inline onclick
    const safeFileName = String(fileName).replace(/'/g, "\\'");

    return (
      '<div class="file-item">' +
        '<div class="file-info">' +
          '<div class="file-name">' + fileName + '</div>' +
          '<div class="file-meta">' + fileDate + ' • ' + fileType + '</div>' +
        '</div>' +
        '<div class="file-actions">' +
          '<a href="' + downloadUrl + '" target="_blank" rel="noopener" class="download-btn" onclick="logDownload(\'' + safeFileName + '\')">' +
            '<span class="download-icon">↓</span>' +
          '</a>' +
        '</div>' +
      '</div>'
    );
  }).join('');
}

function logDownload(fileName) {
  logDownloadActivity('File download', currentUser?.email, fileName);
}

function logDownloadActivity(action, userEmail, fileName) {
  const logData = {
    action: action,
    user: userEmail || (currentUser ? currentUser.email : ''),
    orderId: orderData?.ID,
    opid: orderData?.OPID,
    file: fileName || null,
    timestamp: new Date().toISOString()
  };
  console.log('Activity logged:', logData);
}

// ===============================
// Update Form (open/close/validate/submit)
// ===============================
let originalOrderStatus = null;
let originalTrafficStatus = null;

function openUpdateForm() {
  reqEl('updateModalOverlay').classList.add('show');

  originalOrderStatus   = orderData.Status?.Value || orderData.Status || '';
  originalTrafficStatus = orderData.TrafficStatus?.Value || orderData.TrafficStatus || '';

  // Current statuses
  const currentOrderStatus   = originalOrderStatus;
  const currentTrafficStatus = originalTrafficStatus;

  const orderSection   = document.querySelector('.update-form-section:nth-of-type(1)');
  const trafficSection = document.querySelector('.update-form-section:nth-of-type(2)');

  // Order section enable/disable
  if (currentOrderStatus === 'Not Uploaded') {
    orderSection.style.opacity = '0.5';
    orderSection.style.pointerEvents = 'none';
    if (!orderSection.querySelector('.status-disabled-note')) {
      const note = document.createElement('div');
      note.className = 'status-disabled-note';
      note.style.cssText = 'background: #fff4ce; padding: 12px; border-radius: 4px; margin-bottom: 12px; color: #323130; font-size: 14px;';
      note.innerHTML = '<strong>⚠️ Note:</strong> Order status is "Not Uploaded" and cannot be updated at this time.';
      orderSection.insertBefore(note, orderSection.firstChild.nextSibling);
    }
    reqEl('updateOrderStatus').disabled = true;
    reqEl('updateOrderComments').disabled = true;
  } else {
    orderSection.style.opacity = '1';
    orderSection.style.pointerEvents = 'auto';
    const orderNote = orderSection.querySelector('.status-disabled-note');
    if (orderNote) orderNote.remove();
    reqEl('updateOrderStatus').disabled = false;
    reqEl('updateOrderComments').disabled = false;
  }

  // Traffic section enable/disable
  if (currentTrafficStatus === 'Not Uploaded') {
    trafficSection.style.opacity = '0.5';
    trafficSection.style.pointerEvents = 'none';
    if (!trafficSection.querySelector('.status-disabled-note')) {
      const note = document.createElement('div');
      note.className = 'status-disabled-note';
      note.style.cssText = 'background: #fff4ce; padding: 12px; border-radius: 4px; margin-bottom: 12px; color: #323130; font-size: 14px;';
      note.innerHTML = '<strong>⚠️ Note:</strong> Traffic status is "Not Uploaded" and cannot be updated at this time.';
      trafficSection.insertBefore(note, trafficSection.firstChild.nextSibling);
    }
    reqEl('updateTrafficStatus').disabled = true;
    reqEl('updateTrafficComments').disabled = true;
  } else {
    trafficSection.style.opacity = '1';
    trafficSection.style.pointerEvents = 'auto';
    const trafficNote = trafficSection.querySelector('.status-disabled-note');
    if (trafficNote) trafficNote.remove();
    reqEl('updateTrafficStatus').disabled = false;
    reqEl('updateTrafficComments').disabled = false;
  }

  updateFormValidation();
}

function emailTeam() {
  // Prefer actual emails when available
  const aeEmail = orderData.AE?.Email || '';
  const cmEmail = orderData.CampaignManager?.Email || orderData.CM?.Email || '';
  const toEmails = [aeEmail, cmEmail].filter(Boolean).join(',');
  const ccEmail = 'kostiantyn.rymar@ampersand.tv';

  const advertiser = orderData.Title || orderData.Advertiser || 'Order';
  const flightStart = formatDate(orderData.FlightStart);
  const flightEnd   = formatDate(orderData.FlightEnd);
  const opid        = orderData.OPID || '';

  const subject = `${advertiser} (${flightStart} - ${flightEnd}) - ${opid}`;
  const body = 'Hi Team,%0D%0A%0D%0AI have a question regarding this order.%0D%0A%0D%0AThank you!';
  const mailtoLink = 'mailto:' + toEmails + '?cc=' + ccEmail + '&subject=' + encodeURIComponent(subject) + '&body=' + body;
  window.location.href = mailtoLink;
}

function closeUpdateForm() {
  reqEl('updateModalOverlay').classList.remove('show');
  reqEl('updateOrderStatus').value = '';
  reqEl('updateOrderComments').value = '';
  reqEl('updateTrafficStatus').value = '';
  reqEl('updateTrafficComments').value = '';
}

function updateFormValidation() {
  const orderStatus     = reqEl('updateOrderStatus').value;
  const trafficStatus   = reqEl('updateTrafficStatus').value;
  const orderComments   = reqEl('updateOrderComments').value.trim();
  const trafficComments = reqEl('updateTrafficComments').value.trim();

  const orderDisabled   = reqEl('updateOrderStatus').disabled;
  const trafficDisabled = reqEl('updateTrafficStatus').disabled;

  const orderCommentLabel   = reqEl('orderCommentLabel');
  const trafficCommentLabel = reqEl('trafficCommentLabel');

  orderCommentLabel.innerHTML   = (orderStatus   === 'Rejected') ? 'Comments <span class="required">*</span> (required for rejection)'   : 'Comments <span style="color: #605e5c;">(optional)</span>';
  trafficCommentLabel.innerHTML = (trafficStatus === 'Rejected') ? 'Comments <span class="required">*</span> (required for rejection)' : 'Comments <span style="color: #605e5c;">(optional)</span>';

  let isValid = true;

  if (!orderDisabled && orderStatus === 'Rejected'  && !orderComments)   isValid = false;
  if (!trafficDisabled && trafficStatus === 'Rejected' && !trafficComments) isValid = false;

  const hasOrderSelection   = !orderDisabled   && !!orderStatus;
  const hasTrafficSelection = !trafficDisabled && !!trafficStatus;
  if (!hasOrderSelection && !hasTrafficSelection) isValid = false;
  if (orderDisabled && trafficDisabled) isValid = false;

  reqEl('submitUpdateBtn').disabled = !isValid;
}

document.getElementById('updateOrderStatus').addEventListener('change', updateFormValidation);
document.getElementById('updateTrafficStatus').addEventListener('change', updateFormValidation);
document.getElementById('updateOrderComments').addEventListener('input', updateFormValidation);
document.getElementById('updateTrafficComments').addEventListener('input', updateFormValidation);

function submitUpdate() {
  const orderStatus     = reqEl('updateOrderStatus').value;
  const trafficStatus   = reqEl('updateTrafficStatus').value;
  const orderComments   = reqEl('updateOrderComments').value.trim();
  const trafficComments = reqEl('updateTrafficComments').value.trim();

  const orderChanged   = orderStatus   && (orderStatus   !== originalOrderStatus);
  const trafficChanged = trafficStatus && (trafficStatus !== originalTrafficStatus);

  let changeType = null;
  if (orderChanged && trafficChanged) changeType = 'both';
  else if (orderChanged)              changeType = 'io';
  else if (trafficChanged)            changeType = 'traffic';

  const updateData = {
    change_type: changeType,
    user: currentUser.email,
    id: orderId
  };

  if (orderChanged) {
    updateData.io = {
      status: orderStatus,
      comment: orderComments || ''
    };
  }
  if (trafficChanged) {
    updateData.traffic = {
      status: trafficStatus,
      comment: trafficComments || ''
    };
  }

  console.log('=== SUBMISSION DATA ===');
  console.log(JSON.stringify(updateData, null, 2));
  console.log('======================');

  const updateApiUrl = 'https://default4657d5eea660475fbb1099b5df3efd.46.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ddb6aeaa697448b5a3f466170aebad6f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=4HQQMYaekXI0s6exdOb-Ud7vmCNX19Y2K9h8sXjHru4';

  const submitBtn = reqEl('submitUpdateBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';

  fetch(updateApiUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify(updateData)
  })
  .then(function(response) {
    console.log('Response status:', response.status);
    if (!response.ok) {
      throw new Error('Submission failed: ' + response.status);
    }
    return response.text().then(function(text) {
      console.log('Raw response text:', text);
      try {
        return JSON.parse(text);
      } catch (e) {
        console.error('JSON parse error:', e);
        console.error('Response was:', text);
        throw new Error('Invalid JSON response from server');
      }
    });
  })
  .then(function(data) {
    console.log('Success response:', data);
    if (data.order) {
      orderData = normalizeOrder(data.order);
      populateOrderDetails();
      console.log('Order data updated from server');
    }
    alert('Update submitted successfully!\n\nYour changes have been recorded.');
    closeUpdateForm();
  })
  .catch(function(error) {
    console.error('Submission error:', error);
    alert('Failed to submit update.\n\nPlease try again or contact support if the issue persists.');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit Update';
  });
}

// ===============================
// Boot
// ===============================
checkAuthentication();
</script>
</body>
</html>
